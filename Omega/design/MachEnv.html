

<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MachineEnv &mdash; Omega develop documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css" />

  
      <script src="../_static/jquery.js"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
      <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
      <script src="../_static/doctools.js"></script>
      <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Metadata" href="Metadata.html" />
    <link rel="prev" title="Logging" href="Logging.html" />
    <link href="../_static/style.css" rel="stylesheet" type="text/css">

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Omega
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">User's guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../userGuide/QuickStart.html">Quick Start for Users</a></li>
<li class="toctree-l1"><a class="reference internal" href="../userGuide/OmegaBuild.html">CMake-based Omega Build</a></li>
<li class="toctree-l1"><a class="reference internal" href="../userGuide/DataTypes.html">Data Types and Precision</a></li>
<li class="toctree-l1"><a class="reference internal" href="../userGuide/MachEnv.html">Machine Environment (MachEnv)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../userGuide/Config.html">Model Configuration (Config)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../userGuide/Broadcast.html">Omega Broadcast</a></li>
<li class="toctree-l1"><a class="reference internal" href="../userGuide/Logging.html">Omega Logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../userGuide/Driver.html">Driver</a></li>
<li class="toctree-l1"><a class="reference internal" href="../userGuide/Decomp.html">Domain Decomposition (Decomp)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../userGuide/Dimension.html">Dimension</a></li>
<li class="toctree-l1"><a class="reference internal" href="../userGuide/Error.html">Error handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../userGuide/Field.html">Fields and Metadata (Field)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../userGuide/IO.html">Parallel IO (IO)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../userGuide/IOStreams.html">IO Streams (IOStream)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../userGuide/Halo.html">Halo Exchanges (Halo)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../userGuide/HorzMesh.html">Horizontal Mesh</a></li>
<li class="toctree-l1"><a class="reference internal" href="../userGuide/HorzOperators.html">Horizontal Operators</a></li>
<li class="toctree-l1"><a class="reference internal" href="../userGuide/AuxiliaryVariables.html">Auxiliary Variables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../userGuide/AuxiliaryState.html">Auxiliary State</a></li>
<li class="toctree-l1"><a class="reference internal" href="../userGuide/TendencyTerms.html">Tendency Terms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../userGuide/Tendencies.html">Tendencies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../userGuide/OceanState.html">Ocean State</a></li>
<li class="toctree-l1"><a class="reference internal" href="../userGuide/TimeMgr.html">Time Manager (TimeMgr)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../userGuide/TimeStepping.html">Time stepping</a></li>
<li class="toctree-l1"><a class="reference internal" href="../userGuide/Reductions.html">Global Reductions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../userGuide/Tracers.html">Tracers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../userGuide/TridiagonalSolvers.html">Tridiagonal Solvers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer's guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../devGuide/QuickStart.html">Quick Start for Developers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devGuide/CondaEnv.html">Development Conda Environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devGuide/Linting.html">Linting Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devGuide/Docs.html">Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devGuide/BuildDocs.html">Building the Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devGuide/DataTypes.html">Data Types and Precision</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devGuide/DataTypes.html#arrays-and-kokkos">Arrays and Kokkos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devGuide/MachEnv.html">Machine Environment (MachEnv)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devGuide/Config.html">Model Configuration (Config)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devGuide/Driver.html">Driver</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devGuide/Broadcast.html">Omega Broadcast</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devGuide/CMakeBuild.html">Omega Build with CMake</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devGuide/Logging.html">Developing Omega Logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devGuide/Decomp.html">Domain Decomposition (Decomp)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devGuide/Dimension.html">Dimension</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devGuide/Error.html">Error Handler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devGuide/Field.html">Fields and Metadata (Field)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devGuide/IO.html">Parallel IO (IO)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devGuide/IOStreams.html">IO Streams (IOStream)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devGuide/Halo.html">Halo Exchanges (Halo)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devGuide/HorzMesh.html">Horizontal Mesh</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devGuide/HorzOperators.html">Horizontal Operators</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devGuide/AuxiliaryVariables.html">Auxiliary Variables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devGuide/AuxiliaryState.html">Auxiliary State</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devGuide/TendencyTerms.html">Tendency Terms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devGuide/Tendencies.html">Tendencies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devGuide/OceanState.html">Ocean State</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devGuide/TimeMgr.html">Time Manager (TimeMgr)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devGuide/TimeStepping.html">Time stepping</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devGuide/Reductions.html">Global Reductions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devGuide/Tracers.html">Tracers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devGuide/TridiagonalSolvers.html">Tridiagonal Solvers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Design documents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="OmegaV0ShallowWater.html">Omega V0: Shallow Water</a></li>
<li class="toctree-l1"><a class="reference internal" href="Broadcast.html">Broadcast</a></li>
<li class="toctree-l1"><a class="reference internal" href="Config.html">Config</a></li>
<li class="toctree-l1"><a class="reference internal" href="DataTypes.html">DataTypes</a></li>
<li class="toctree-l1"><a class="reference internal" href="Decomp.html">Decomp</a></li>
<li class="toctree-l1"><a class="reference internal" href="Driver.html">Driver and Component Layer</a></li>
<li class="toctree-l1"><a class="reference internal" href="EOS.html">Equation of State</a></li>
<li class="toctree-l1"><a class="reference internal" href="Error.html">ErrorHandler (Error)</a></li>
<li class="toctree-l1"><a class="reference internal" href="Halo.html">Halo</a></li>
<li class="toctree-l1"><a class="reference internal" href="HorzMeshClass.html">Horizontal Mesh</a></li>
<li class="toctree-l1"><a class="reference internal" href="Logging.html">Logging</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">MachineEnv</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#overview">1 Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="#requirements">2 Requirements</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#requirement-initialize-mpi-in-standalone">2.1 Requirement: Initialize MPI in Standalone</a></li>
<li class="toctree-l3"><a class="reference internal" href="#requirement-create-mpi-communicator-in-coupled-mode">2.2 Requirement: Create MPI communicator in coupled mode</a></li>
<li class="toctree-l3"><a class="reference internal" href="#requirement-define-mpi-layouts">2.3 Requirement: Define MPI layouts</a></li>
<li class="toctree-l3"><a class="reference internal" href="#requirement-kokkos-initialization">2.4 Requirement: Kokkos initialization</a></li>
<li class="toctree-l3"><a class="reference internal" href="#requirement-vector-blocking-size-defined-at-compile-time">2.5 Requirement: Vector blocking size defined at compile time</a></li>
<li class="toctree-l3"><a class="reference internal" href="#desired-set-alternative-master-task">2.6 Desired: Set alternative master task</a></li>
<li class="toctree-l3"><a class="reference internal" href="#desired-multiple-environments">2.7 Desired: Multiple environments</a></li>
<li class="toctree-l3"><a class="reference internal" href="#desired-define-threading-parameters">2.8 Desired: Define threading parameters</a></li>
<li class="toctree-l3"><a class="reference internal" href="#desired-define-other-machine-parameters">2.9 Desired: Define other machine parameters</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#algorithmic-formulation">3 Algorithmic Formulation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#design">4 Design</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#data-types-and-parameters">4.1 Data types and parameters</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#parameters">4.1.1 Parameters</a></li>
<li class="toctree-l4"><a class="reference internal" href="#class-structs-data-types">4.1.2 Class/structs/data types</a></li>
<li class="toctree-l4"><a class="reference internal" href="#default-environment">4.1.3 Default environment</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#methods">4.2 Methods</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#initialization">4.2.1 Initialization</a></li>
<li class="toctree-l4"><a class="reference internal" href="#constructors">4.2.2 Constructors</a></li>
<li class="toctree-l4"><a class="reference internal" href="#get-retrieval">4.2.2 Get/Retrieval</a></li>
<li class="toctree-l4"><a class="reference internal" href="#change-master-task">4.2.3 Change master task</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#verification-and-testing">5 Verification and Testing</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#test-standalone-initialization">5.1 Test standalone initialization</a></li>
<li class="toctree-l3"><a class="reference internal" href="#test-changing-master-task">5.2 Test changing master task</a></li>
<li class="toctree-l3"><a class="reference internal" href="#test-multiple-environments">5.3 Test multiple environments</a></li>
<li class="toctree-l3"><a class="reference internal" href="#initialization-in-coupled-mode">5.4 Initialization in coupled mode</a></li>
<li class="toctree-l3"><a class="reference internal" href="#test-vector-blocking-factor">5.5 Test vector blocking factor</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="Metadata.html">Metadata</a></li>
<li class="toctree-l1"><a class="reference internal" href="IO.html">Input/Output (IO)</a></li>
<li class="toctree-l1"><a class="reference internal" href="IOStreams.html">IOStreams</a></li>
<li class="toctree-l1"><a class="reference internal" href="Reductions.html">Global Reductions</a></li>
<li class="toctree-l1"><a class="reference internal" href="State.html">State</a></li>
<li class="toctree-l1"><a class="reference internal" href="Tendency.html">Tendency</a></li>
<li class="toctree-l1"><a class="reference internal" href="Tendencies.html">Tendencies</a></li>
<li class="toctree-l1"><a class="reference internal" href="AuxiliaryVariables.html">Auxiliary variables</a></li>
<li class="toctree-l1"><a class="reference internal" href="AuxiliaryState.html">AuxiliaryState</a></li>
<li class="toctree-l1"><a class="reference internal" href="TimeMgr.html">TimeManager</a></li>
<li class="toctree-l1"><a class="reference internal" href="Timers.html">Timers</a></li>
<li class="toctree-l1"><a class="reference internal" href="TimeStepping.html">Time Stepping</a></li>
<li class="toctree-l1"><a class="reference internal" href="Tracers.html">Tracer Infrastructure</a></li>
<li class="toctree-l1"><a class="reference internal" href="TridiagonalSolver.html">Tridiagonal Solver</a></li>
<li class="toctree-l1"><a class="reference internal" href="VerticalMixingCoeff.html">Vertical Mixing Coefficients</a></li>
<li class="toctree-l1"><a class="reference internal" href="Template.html">Template</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Omega</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">MachineEnv</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/design/MachEnv.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section class="tex2jax_ignore mathjax_ignore" id="machineenv">
<span id="omega-design-machine-env"></span><h1>MachineEnv<a class="headerlink" href="#machineenv" title="Permalink to this heading"></a></h1>
<section id="overview">
<h2>1 Overview<a class="headerlink" href="#overview" title="Permalink to this heading"></a></h2>
<p>On startup, OMEGA will need to initialize the message-passing and other
environments and set up parameters related to machine layout, messaging,
and hardware for use throughout OMEGA.</p>
</section>
<section id="requirements">
<h2>2 Requirements<a class="headerlink" href="#requirements" title="Permalink to this heading"></a></h2>
<section id="requirement-initialize-mpi-in-standalone">
<h3>2.1 Requirement: Initialize MPI in Standalone<a class="headerlink" href="#requirement-initialize-mpi-in-standalone" title="Permalink to this heading"></a></h3>
<p>In standalone mode, OMEGA will need to initialize the MPI environment
and define a default communicator.</p>
</section>
<section id="requirement-create-mpi-communicator-in-coupled-mode">
<h3>2.2 Requirement: Create MPI communicator in coupled mode<a class="headerlink" href="#requirement-create-mpi-communicator-in-coupled-mode" title="Permalink to this heading"></a></h3>
<p>When running as part of a coupled system, OMEGA will need to define a default
communicator based on a parent communicator sent by the calling routine
(coupler or parent model).</p>
</section>
<section id="requirement-define-mpi-layouts">
<h3>2.3 Requirement: Define MPI layouts<a class="headerlink" href="#requirement-define-mpi-layouts" title="Permalink to this heading"></a></h3>
<p>Each MPI rank will need to know its own rank id, number of ranks and
define a master rank.</p>
</section>
<section id="requirement-kokkos-initialization">
<h3>2.4 Requirement: Kokkos initialization<a class="headerlink" href="#requirement-kokkos-initialization" title="Permalink to this heading"></a></h3>
<p>Since we are using Kokkos for kernel launching and array types, we
will need to initialize Kokkos in standalone mode. It may also be
needed for coupled simulations.</p>
</section>
<section id="requirement-vector-blocking-size-defined-at-compile-time">
<h3>2.5 Requirement: Vector blocking size defined at compile time<a class="headerlink" href="#requirement-vector-blocking-size-defined-at-compile-time" title="Permalink to this heading"></a></h3>
<p>To achieve the best CPU performance, especially when using
GPU-friendly loop forms, it is useful to explicitly size inner
loops based on a compile-time length (chunk size) that is a multiple
of the vector length.</p>
</section>
<section id="desired-set-alternative-master-task">
<h3>2.6 Desired: Set alternative master task<a class="headerlink" href="#desired-set-alternative-master-task" title="Permalink to this heading"></a></h3>
<p>While rank 0 is typically used as a master task, it is sometimes desirable
to assign a different rank as master to avoid overloading rank 0, especially
when running in coupled mode with other components also using the same rank.</p>
</section>
<section id="desired-multiple-environments">
<h3>2.7 Desired: Multiple environments<a class="headerlink" href="#desired-multiple-environments" title="Permalink to this heading"></a></h3>
<p>In OMEGA, we may wish to run sub-components on different partitions. For
example, we might want to rearrange the communication-dominated
barotropic solve to run on fewer nodes or within a single node. We will
need to be able to create new environments based on a subset of an
existing environment. In setting up multiple environments, it will
be desireable to have some awareness of network topology for optimal
task placement.</p>
</section>
<section id="desired-define-threading-parameters">
<h3>2.8 Desired: Define threading parameters<a class="headerlink" href="#desired-define-threading-parameters" title="Permalink to this heading"></a></h3>
<p>If OpenMP threading is enabled for CPU, it may be useful to also define
similar master threads and thread layouts to enable some task parallelism
within an MPI rank.</p>
</section>
<section id="desired-define-other-machine-parameters">
<h3>2.9 Desired: Define other machine parameters<a class="headerlink" href="#desired-define-other-machine-parameters" title="Permalink to this heading"></a></h3>
<p>In the future, it may be useful to define other machine parameters, like
the specific configuration of cores, accelerators and other devices, to
manage task assignments on hybrid nodes. It should be easy to modify
this class to add additional information.</p>
</section>
</section>
<section id="algorithmic-formulation">
<h2>3 Algorithmic Formulation<a class="headerlink" href="#algorithmic-formulation" title="Permalink to this heading"></a></h2>
<p>No algorithms are needed beyond what is provided by standard MPI, OpenMP
libraries.</p>
</section>
<section id="design">
<h2>4 Design<a class="headerlink" href="#design" title="Permalink to this heading"></a></h2>
<p>In general, this is a simple class to hold information for later
retrieval.</p>
<section id="data-types-and-parameters">
<h3>4.1 Data types and parameters<a class="headerlink" href="#data-types-and-parameters" title="Permalink to this heading"></a></h3>
<section id="parameters">
<h4>4.1.1 Parameters<a class="headerlink" href="#parameters" title="Permalink to this heading"></a></h4>
<p>For improved vector performance on CPU and perhaps match thread block
sizes on GPU, we wish to block the inner loops with a compile-time
parameter. We define a CPP parameter: <code class="docutils literal notranslate"><span class="pre">OMEGA_VECTOR_SIZE</span></code>. This is
dependent on the machine and on whether GPU acceleration is enabled.
It will typically take on values like 16, 32, 64 for CPU-only builds
and 1 for GPU builds to maximize parallelism.</p>
</section>
<section id="class-structs-data-types">
<h4>4.1.2 Class/structs/data types<a class="headerlink" href="#class-structs-data-types" title="Permalink to this heading"></a></h4>
<p>There will be a simple class MachEnv. We use a class here rather than
a struct so that we can make members private to prevent overwriting
these variables.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">MachEnv</span><span class="w"> </span><span class="p">{</span>

<span class="w">   </span><span class="k">private</span><span class="o">:</span>
<span class="w">      </span><span class="kt">int</span><span class="w"> </span><span class="n">mComm</span><span class="p">;</span><span class="w">      </span><span class="c1">///&lt; MPI communicator for this environment</span>
<span class="w">      </span><span class="kt">int</span><span class="w"> </span><span class="n">mMyRank</span><span class="p">;</span><span class="w">    </span><span class="c1">///&lt; rank ID for local MPI rank</span>
<span class="w">      </span><span class="kt">int</span><span class="w"> </span><span class="n">mNumRanks</span><span class="p">;</span><span class="w">  </span><span class="c1">///&lt; total number of MPI ranks</span>
<span class="w">      </span><span class="kt">int</span><span class="w"> </span><span class="n">mMasterRank</span><span class="p">;</span><span class="c1">///&lt; rank ID for master rank</span>
<span class="w">      </span><span class="kt">bool</span><span class="w"> </span><span class="n">mIsMaster</span><span class="p">;</span><span class="w"> </span><span class="c1">///&lt; true if the local rank is the master</span>

<span class="w">   </span><span class="k">public</span><span class="o">:</span>

<span class="w">      </span><span class="c1">// Methods</span>
<span class="w">      </span><span class="p">[</span><span class="n">define</span><span class="w"> </span><span class="n">methods</span><span class="w"> </span><span class="n">here</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">see</span><span class="w"> </span><span class="n">below</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="default-environment">
<h4>4.1.3 Default environment<a class="headerlink" href="#default-environment" title="Permalink to this heading"></a></h4>
<p>We will keep a default environment <code class="docutils literal notranslate"><span class="pre">OMEGA::defaultEnv</span></code> as a public
static instantiation that will be used by most of the OMEGA infrastructure.
If other environments are created, they must be maintained by the
defining routines or sub-components.</p>
</section>
</section>
<section id="methods">
<h3>4.2 Methods<a class="headerlink" href="#methods" title="Permalink to this heading"></a></h3>
<section id="initialization">
<h4>4.2.1 Initialization<a class="headerlink" href="#initialization" title="Permalink to this heading"></a></h4>
<p>There will be two forms of the initialization routines. One of
these two must be called as early as possible in OMEGA initialization
(typically the first call). Both forms will return an integer
error code and will define the default environment <code class="docutils literal notranslate"><span class="pre">OMEGA::defaultEnv</span></code>.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// Initialization - standalone</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">MachEnvInit</span><span class="p">();</span>

<span class="c1">// Initialization - coupled</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">MachEnvInit</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">inCommunicator</span><span class="p">,</span><span class="w"> </span><span class="c1">///&lt; [in] parent MPI communicator</span>
<span class="w">                </span><span class="p">);</span>
</pre></div>
</div>
</section>
<section id="constructors">
<h4>4.2.2 Constructors<a class="headerlink" href="#constructors" title="Permalink to this heading"></a></h4>
<p>We provide several constructors for creating instances of the environment.
These will be used primarily by the above initialization routine, though
can also be used to create additional environments per requirement 2.7.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// Generic constructor that uses `MPI_COMM_WORLD`</span>
<span class="n">MachEnv</span><span class="p">();</span>

<span class="c1">// Constructor that uses an assigned communicator (eg from coupler)</span>
<span class="n">MachEnv</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">inCommunicator</span><span class="w"> </span><span class="c1">///&lt; [in] parent MPI communicator</span>
<span class="w">        </span><span class="p">);</span>

<span class="c1">// Create a new environment from a contiguous subset of an</span>
<span class="c1">// existing environment</span>
<span class="n">MachEnv</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">inCommunicator</span><span class="p">,</span><span class="c1">///&lt; [in] parent MPI communicator</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">newSize</span><span class="w">        </span><span class="c1">///&lt; [in] use first newSize ranks</span>
<span class="w">        </span><span class="p">);</span>

<span class="c1">// Create a new environment from a strided subset of an</span>
<span class="c1">// existing environment</span>
<span class="n">MachEnv</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">inCommunicator</span><span class="p">,</span><span class="c1">///&lt; [in] parent MPI communicator</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">newSize</span><span class="p">,</span><span class="w">       </span><span class="c1">///&lt; [in] num ranks in new env</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">begin</span><span class="p">,</span><span class="w">         </span><span class="c1">///&lt; [in] starting parent rank</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">stride</span><span class="w">         </span><span class="c1">///&lt; [in] stride for ranks to incl</span>
<span class="w">        </span><span class="p">);</span>

<span class="c1">// Create a new environment from a custome subset of an</span>
<span class="c1">// existing environment, supplying list of parent ranks to include</span>
<span class="n">MachEnv</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">inCommunicator</span><span class="w"> </span><span class="c1">///&lt; [in] parent MPI communicator</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">newSize</span><span class="p">,</span><span class="w">       </span><span class="c1">///&lt; [in] num ranks in new env</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ranks</span><span class="p">[]</span><span class="w">        </span><span class="c1">///&lt; [in] vector of parent ranks to incl</span>
<span class="w">        </span><span class="p">);</span>
</pre></div>
</div>
<p>In standalone mode, the simple constructor would be used:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">MachEnv</span><span class="w"> </span><span class="nf">omegaEnv</span><span class="p">();</span><span class="w"> </span><span class="c1">// Initialize MPI and machine environment</span>
</pre></div>
</div>
<p>and would define <code class="docutils literal notranslate"><span class="pre">MPI_COMM_WORLD</span></code> as the communicator as well
as initialize various other environments as needed.  In coupled mode,
the second form would be used with the coupler passing the
appropriate communicator to be used.</p>
<p>To satisfy requirement 2.7, we provide three forms to create a new
environment based on subsets of the old. The first simply creates
a subset from the first newSize ranks of the parent. The second
creates a strided subset (every “n” ranks starting from a specified
beginning rank). A third is the most general and creates a subset from
a vector of specific ranks of the parent to include in the new environment.</p>
</section>
<section id="get-retrieval">
<h4>4.2.2 Get/Retrieval<a class="headerlink" href="#get-retrieval" title="Permalink to this heading"></a></h4>
<p>We provide specific retrieval functions for each class member to mimic
using this environment as a struct:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">Comm</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span><span class="w">      </span><span class="c1">///&lt; returns MPI communicator for this environment</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">MyRank</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span><span class="w">    </span><span class="c1">///&lt; returns local MPI rank</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">NumRanks</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span><span class="w">  </span><span class="c1">///&lt; total number of MPI ranks</span>
</pre></div>
</div>
<p>In typical use, these would look like:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">myRank</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OMEGA</span><span class="o">::</span><span class="n">defaultEnv</span><span class="p">.</span><span class="n">MyRank</span><span class="p">();</span><span class="w"> </span><span class="c1">// retrieve local rank id</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">OMEGA</span><span class="o">::</span><span class="n">defaultEnv</span><span class="p">.</span><span class="n">IsMaster</span><span class="p">()){</span>
<span class="w">   </span><span class="c1">// do stuff on master rank</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="change-master-task">
<h4>4.2.3 Change master task<a class="headerlink" href="#change-master-task" title="Permalink to this heading"></a></h4>
<p>While most of the members should not be modified (read only using the get above), we will need a single set function to satisfy requirement 2.6.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">SetMaster</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">newMasterRank</span><span class="p">);</span>
</pre></div>
</div>
<p>Note that this should occur as soon as possible after the environment is
created. Resetting the master after other activities have already assumed
the default master rank could leave variables defined on the wrong rank
and undefined on the new master rank. The integer return value is a
success/fail return code.</p>
</section>
</section>
</section>
<section id="verification-and-testing">
<h2>5 Verification and Testing<a class="headerlink" href="#verification-and-testing" title="Permalink to this heading"></a></h2>
<p>We will test this with a simple test driver in an 8-rank
MPI configuration. Requirement 2.4 (Kokkos initialization) will
need to be verified by visual inspection but later tests using
Kokkos functions will determine whether this has been successful.</p>
<section id="test-standalone-initialization">
<h3>5.1 Test standalone initialization<a class="headerlink" href="#test-standalone-initialization" title="Permalink to this heading"></a></h3>
<p>The test driver will call the standalone initialization, then
verify by retrieving the members and comparing to the equivalent
native MPI calls on <code class="docutils literal notranslate"><span class="pre">MPI_COMM_WORLD</span></code></p>
<ul class="simple">
<li><p>tests requirement 2.1, 2.3 and retrieval functions</p></li>
</ul>
</section>
<section id="test-changing-master-task">
<h3>5.2 Test changing master task<a class="headerlink" href="#test-changing-master-task" title="Permalink to this heading"></a></h3>
<p>After the above test, use the set function to change the master
task to 1 and then verify using the retrieval function</p>
<ul class="simple">
<li><p>tests requirement 2.6</p></li>
</ul>
</section>
<section id="test-multiple-environments">
<h3>5.3 Test multiple environments<a class="headerlink" href="#test-multiple-environments" title="Permalink to this heading"></a></h3>
<p>Create three new environments using each of the three subset
constructors with the first creating a new environment using
the first 4 ranks, the second using every other rank (stride 2),
and the third using ranks 1,2,5,7. Verify that the members are
as expected when compared to the parent environment.</p>
<ul class="simple">
<li><p>tests requirement 2.7</p></li>
</ul>
</section>
<section id="initialization-in-coupled-mode">
<h3>5.4 Initialization in coupled mode<a class="headerlink" href="#initialization-in-coupled-mode" title="Permalink to this heading"></a></h3>
<p>While we can’t test this directly in a standalone test driver,
we can test the underlying constructor by passing one of the
subset communicators as the input and verifying the resulting
environment is the same as the subset environment.</p>
<ul class="simple">
<li><p>tests requirement 2.2 (mostly)</p></li>
</ul>
</section>
<section id="test-vector-blocking-factor">
<h3>5.5 Test vector blocking factor<a class="headerlink" href="#test-vector-blocking-factor" title="Permalink to this heading"></a></h3>
<p>Within the test driver, set an int variable to <code class="docutils literal notranslate"><span class="pre">OMEGA_VECTOR_SIZE</span></code>,
and build the test with <code class="docutils literal notranslate"><span class="pre">-D</span> <span class="pre">OMEGA_VECTOR_SIZE=16</span></code>. Verify the
internal variable is also 16 to test that the preprocessor properly
propagates the value internally.</p>
<ul class="simple">
<li><p>tests requirement 2.5</p></li>
</ul>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="Logging.html" class="btn btn-neutral float-left" title="Logging" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="Metadata.html" class="btn btn-neutral float-right" title="Metadata" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Energy Exascale Earth System Model Project.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>